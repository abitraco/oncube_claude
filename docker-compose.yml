services:
  oncube-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: oncube-web
    ports:
      - "80:80"
      - "443:443"
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY:-base64:placeholder}
      APP_URL: https://oncube.cloud
      LOG_CHANNEL: stderr
      DB_CONNECTION: sqlite
      EBAY_CLIENT_ID: ${EBAY_CLIENT_ID}
      EBAY_CLIENT_SECRET: ${EBAY_CLIENT_SECRET}
      EBAY_LEGACY_APP_ID: ${EBAY_LEGACY_APP_ID}
    volumes:
      - oncube-storage:/app/storage
      - oncube-database:/app/database
      - oncube-writable:/app/writable
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    restart: unless-stopped
    command: >
      sh -c "
      chown -R application:application /app/storage /app/writable /app/database &&
      chmod -R 775 /app/storage /app/writable /app/database &&
      php artisan config:cache &&
      php artisan route:cache &&
      php artisan view:cache &&
      supervisord -c /opt/docker/etc/supervisor.conf
      "

volumes:
  oncube-storage:
    driver: local
  oncube-database:
    driver: local
  oncube-writable:
    driver: local
  letsencrypt:
    driver: local
  certbot-www:
    driver: local
